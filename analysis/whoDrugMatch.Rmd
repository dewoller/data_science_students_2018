---
title: "Who Drug Match"
author: "Nirmala"
date: "July 31, 2018"
output: html_document
---
```{r loadlibrary,message=FALSE}
 library('tidyverse')
 library('workflowr')
 library('stringr')
 source('lib/function.R')  
```

# Match drug from who table
* Tasks:
1) read both ddd_who and pbs_item data
2) create final pbs to store the final data that is cleaned
* The main task is to match the drug form pbs_item with ddd_who table
* ddd_who: contains data from ddd_who table
* pbs_item: contains data from pbs-item table
* final_pbs: copy of pbs_item along with form_type, unit_wt and adm_route whose initial values are NA

```{r prepare data}
ddd_who <- read.csv(file="data/ddd_who.csv",header=TRUE,sep=";")
pbs_item <- read.csv(file="data/pbs_item.csv",header=TRUE, sep=";") 



#create a copy of pbs_item dataframe and add three columns:form_type ,unit_wt,adm_route
final_pbs <- cbind(pbs_item) 
final_pbs["form_type"] <- NA
final_pbs["unit_wt"] <- NA
final_pbs["adm_route"] <-NA 
```
# Try to categorise the different form_strengths
* Tasks:
1) find out what types they are
2) find out how many grams they are
* words: contains the collection of possible categories that is figured out from form_strength of pbs_item
* x: list of the matching words in form_strength with words


```{r possible categories}
#list of types
words <- c("Tablet","Injection","Eye Drops" , "Capsule","Cream","Ear Drops","Inhalation","Mixtures","other","Nasal","Ointment","Oral","Transdermal","Suppositories","Mouth","lotions","Intravesical","Lemella","Parenteral","I.V.","Sublingual","Rectal","Implant","Vaginal","Lamella","Syrup","Elixir","Lozenge","Wafer")

cat("What are the possible categories in form strength?")
words

#sapply(words,grepl,final_pbs$form_strength)

# extract the list of matching words
x <- sapply(words, function(x) grepl(tolower(x), tolower(final_pbs$form_strength)))

# paste the matching words together
final_pbs$form_type <- apply(x, 1, function(i) paste0(names(i)[i], collapse = ","))
```

```{r} 

#return all the row that have no specific form_type and replace by unknown
final_pbs$form_type <-final_pbs$form_type %>% replace(.=="","UNKNOWN")
```

# Dertermine the adm_route according to the form_type
* According to form_type determine the adm_route
* For eg: if form_type is Tablet then adm_route will be O i.e. Oral
```{r find admin route} 
final_pbs$adm_route[final_pbs$form_type=="Oral"|final_pbs$form_type=="Tablet"|final_pbs$form_type=="Capsule"|final_pbs$form_type=="Mouth"|final_pbs$form_type == "Lozenge"|final_pbs$form_type == "Elixir"|final_pbs$form_type == "Wafer"|final_pbs$form_type == "Syrup"|final_pbs$form_type=="Sublingual"]="O"
final_pbs$adm_route[final_pbs$form_type=="Nasal"]="N"
final_pbs$adm_route[final_pbs$form_type=="Ointment"]="Ointment"
final_pbs$adm_route[final_pbs$form_type=="Instillation"]="Instill"
final_pbs$adm_route[final_pbs$form_type=="Cream"|final_pbs$form_type=="lotions"|final_pbs$form_type=="Transdermal"]="TD"
final_pbs$adm_route[final_pbs$form_type=="lamella"]="lamella"
final_pbs$adm_route[final_pbs$form_type=="Rectal"]="R"
final_pbs$adm_route[final_pbs$form_type=="Vaginal"]="V"
final_pbs$adm_route[final_pbs$form_type=="Injection"|final_pbs$form_type=="Eye lotion"| final_pbs$form_type =="Eye Drops"|final_pbs$form_type=="Ear Drops"|final_pbs$form_type=="Parenteral"|final_pbs$form_type=="I.V."]="P"
final_pbs$adm_route[final_pbs$form_type=="Inhalation"]="Inhal"
final_pbs$adm_route[final_pbs$form_type=="Implant"]="Implant"
final_pbs$adm_route[final_pbs$form_type=="Intravesical"] = "Intravesical"
final_pbs$adm_route[final_pbs$form_type=="UNKNOWN"]="UNKNOWN"
final_pbs$adm_route[final_pbs$form_type=="Tablet,Oral"]="O"
final_pbs$adm_route[final_pbs$form_type=="Injection,I.V."]="P"
final_pbs$adm_route[final_pbs$form_type=="Sublingual,Wafer"]="P"
```


# Find how many mg?
* Tasks
1) change micrograms into mg 
2) get the amount
* Any micrograms in form_strength is converted to mg so that it is easy to get any number before mg
* Using regular expression find the number of mg and enter it in unit_wt column of final_pbs table
```{r} 
final_pbs$form_strength <- str_replace(final_pbs$form_strength, "micrograms", "mg")
#get unit_wt 
final_pbs$unit_wt <- str_extract(final_pbs$form_strength, "\\d+\\s?mg") 
```

# Clean the adm_route of ddd_who to match with pbs_item
* Change the adm_route and make it equivalent to form_type of final_pbs table so that it will be easy to match
* For eg. Inh.sol,Inl.aersol to Inhal
          

```{r} 
ddd_who$adm_route <- str_replace(ddd_who$adm_route, "Inh.*_*", "Inhal")
ddd_who$adm_route <- str_replace(ddd_who$adm_route, "TD.*_*", "TD")
ddd_who$adm_route <- str_replace(ddd_who$adm_route, "oral.*_*", "O")

```



# Join both tables using atc code and admin route; 
* Tasks
1) get distinct pbs_code from existing pbs table
2) write in csv for further use
* To narrow down the search we take those drugs from pbs_item that has atc_code in ddd_who table
* existing_pbs :list of distinct pbs_code  from pbs
* existing_pbs_to match: those list of drug that is required to be match with ddd_who 
* unknown_routes: those list of drug that needs the specific adm routes
```{r }
#get distinct pbs_code for first time
#my_db_get_query("select distinct pbs_code from pbs") -> existing_pbs
#write.csv(existing_pbs, file = 'data/existing_pbs.csv')

#get existing pbs data from csv file
existing_pbs <- data.frame(read.csv(file="data/existing_pbs.csv",header=TRUE, sep=",")[,2]) 
colnames(existing_pbs)<- 'pbs_code'



#filter those drugs that only have atc code in ddd_who table to narrow down search
final_pbs%>%
  inner_join(existing_pbs, by = c("pbs_code"="pbs_code"))%>%
  filter(atc_code %in% ddd_who$atc)%>%
  mutate(uadm_route = adm_route)%>%
  {.} ->existing_pbs_to_match


cat("How many specific adm routes?")
existing_pbs_to_match %>% count(adm_route,sort = TRUE)


#total 82 unknown routes 
existing_pbs_to_match%>%
  filter(is.na(existing_pbs_to_match$adm_route) | existing_pbs_to_match$adm_route =="UNKNOWN")%>%
  {.} ->unknown_routes


write.csv(unknown_routes, file = 'data/unknown_routes.csv')


#update the adm_routes having NA values:
#existing_pbs_to_match$uadm_route[existing_pbs_to_match$atc_code == "R03AC02"] <- "Inhal"
```


# TO Do
* find all the routes for unknown routes in unknown_routes.csv
* finally join existing_pbs_to _match with ddd_who
```{r match with ddd_who table, warning=FALSE}

existing_pbs_to_match%>%
  inner_join(ddd_who, c("atc_code" = "atc","adm_route" = "adm_route")) %>%
  { .} ->pbs_who


pbs_who %>% count(adm_route,sort = TRUE)



```
